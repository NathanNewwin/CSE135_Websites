<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Echo Form</title>
    <link rel="stylesheet" href="/style.css" />
    <style>
        .echo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .echo-row {
            display: grid;
            gap: 6px;
        }

        .echo-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .echo-out {
            white-space: pre-wrap;
            overflow: auto;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(0, 0, 0, 0.12);
            min-height: 120px;
        }

        @media (max-width: 900px) {
            .echo-grid {
                grid-template-columns: 1fr;
            }
        }

        input,
        select,
        textarea,
        button {
            font: inherit;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(0, 0, 0, 0.10);
            color: inherit;
        }

        button {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            background: rgba(255, 255, 255, 0.08);
            color: inherit;
            cursor: pointer;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        code {
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <div class="page">
        <main>
            <section class="card active">
                <h2 class="card-header">Echo Form</h2>

                <p class="tbd">
                    Choose a language, HTTP method, and encoding. The endpoint will echo back what it received plus
                    hostname, time, user-agent, and IP.
                </p>

                <!-- No-JS fallback: normal GET urlencoded to python -->
                <noscript>
                    <div class="card inactive" style="margin-top:12px;">
                        <div class="card-header">
                            <h2>No-JS Mode</h2>
                        </div>
                        <p>JavaScript is off. This fallback submits a basic GET request (x-www-form-urlencoded) to
                            Python.</p>
                        <form method="get" action="/hw2/python/echo-python.py">
                            <div class="echo-grid">
                                <div class="echo-row">
                                    <label>name</label>
                                    <input name="name" />
                                </div>
                                <div class="echo-row">
                                    <label>message</label>
                                    <input name="message" />
                                </div>
                            </div>
                            <div class="echo-actions" style="margin-top:12px;">
                                <button type="submit">Send GET (Python)</button>
                            </div>
                        </form>
                    </div>
                </noscript>

                <!-- JS-enhanced form -->
                <form id="echoForm" action="/hw2/python/echo-python.py" method="post" style="margin-top:12px;">
                    <div class="echo-grid">
                        <div class="echo-row">
                            <label for="lang">Language</label>
                            <select id="lang" name="lang">
                                <option value="/hw2/python/echo-python.py" selected>Python</option>
                                <option value="/hw2/perl/perl-general-echo.pl">Perl (general echo)</option>
                                <option value="/hw2/node/node-general-echo.cgi">NodeJs (general echo)</option>
                                <option value="/hw2/rust/rust-general-echo.cgi">Rust (general echo)</option>
                            </select>
                        </div>

                        <div class="echo-row">
                            <label for="method">HTTP Method</label>
                            <select id="method" name="method">
                                <option value="GET">GET</option>
                                <option value="POST" selected>POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>

                        <div class="echo-row">
                            <label for="encoding">Encoding</label>
                            <select id="encoding" name="encoding">
                                <option value="application/x-www-form-urlencoded" selected>x-www-form-urlencoded
                                </option>
                                <option value="application/json">application/json</option>
                            </select>
                        </div>

                        <div class="echo-row">
                            <label for="endpoint">Endpoint (auto)</label>
                            <input id="endpoint" name="endpoint" type="text" value="/hw2/python/echo-python.py"
                                readonly />
                        </div>

                        <div class="echo-row">
                            <label for="name">name</label>
                            <input id="name" name="name" placeholder="e.g. Nathan" />
                        </div>

                        <div class="echo-row">
                            <label for="message">message</label>
                            <input id="message" name="message" placeholder="e.g. hello from the form" />
                        </div>

                        <div class="echo-row" style="grid-column: 1 / -1;">
                            <label for="extra">extra (optional)</label>
                            <textarea id="extra" name="extra" rows="3" placeholder="Any additional text..."></textarea>
                        </div>
                    </div>

                    <div class="echo-actions" style="margin-top:12px;">
                        <button type="submit">Send</button>
                        <span class="tbd">Response:</span>
                    </div>
                </form>

                <pre class="echo-out" id="out" aria-live="polite">{}</pre>

                <p style="margin-top:10px;">
                    <a href="/hw2/">Back to Homework 2</a>
                </p>
            </section>
        </main>
    </div>

    <script>
        (function () {
            const form = document.getElementById("echoForm");
            const out = document.getElementById("out");
            const lang = document.getElementById("lang");
            const method = document.getElementById("method");
            const encoding = document.getElementById("encoding");
            const endpoint = document.getElementById("endpoint");

            function syncEndpoint() {
                endpoint.value = lang.value;
                form.action = lang.value;
            }

            function buildPayload() {
                const data = {
                    name: document.getElementById("name").value,
                    message: document.getElementById("message").value,
                    extra: document.getElementById("extra").value
                };
                return data;
            }

            syncEndpoint();
            lang.addEventListener("change", syncEndpoint);

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                syncEndpoint();

                const url = form.action;
                const m = method.value;
                const ct = encoding.value;
                const data = buildPayload();

                let fetchUrl = url;
                let options = { method: m, headers: {} };

                if (m === "GET") {
                    // put fields in query string
                    const params = new URLSearchParams(data);
                    fetchUrl = url + "?" + params.toString();
                } else {
                    if (ct === "application/json") {
                        options.headers["Content-Type"] = "application/json";
                        options.body = JSON.stringify(data);
                    } else {
                        options.headers["Content-Type"] = "application/x-www-form-urlencoded";
                        options.body = new URLSearchParams(data).toString();
                    }
                }

                try {
                    out.textContent = "Loading...";
                    const resp = await fetch(fetchUrl, options);
                    const text = await resp.text();

                    // Pretty print JSON if possible
                    try {
                        const obj = JSON.parse(text);
                        out.textContent = JSON.stringify(obj, null, 2);
                    } catch {
                        out.textContent = text;
                    }
                } catch (err) {
                    out.textContent = "Request failed: " + err;
                }
            });
        })();
    </script>
</body>

</html>