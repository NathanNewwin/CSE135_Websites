<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Chamber</title>
    <link rel="stylesheet" href="../style.css">
</head>

<body>

    <div class="page">

        <div class="left-col">
            <header class="course-header">
                <h1 class="course-title">Echo Chamber</h1>
                <p class="course-subtitle">Test HTTP Methods & Encodings</p>
            </header>

            <div style="flex-grow: 1; min-height: 200px;"></div>

            <div class="card active">
                <h2>Status</h2>
                <p><strong>JavaScript:</strong> <span id="js-status" style="color: #ff8888;">OFF</span></p>
                <p style="font-size: 0.9em; opacity: 0.8; line-height: 1.5;">
                    If JS is OFF, the form defaults to <code>POST</code> and targeting the Python endpoint using
                    standard URL encoding.
                </p>
            </div>
        </div>

        <div class="sidebar">
            <h2>Request Config</h2>

            <form id="echoForm" action="python/echo-python.py" method="POST">

                <label for="endpoint">Target Endpoint</label>
                <select id="endpoint" name="endpoint">
                    <option value="python/echo-python.py">Python</option>
                    <option value="node/echo-node.js">Node.js (TBD)</option>
                    <option value="rust/echo-rust">Rust (TBD)</option>
                </select>

                <label for="method">HTTP Method</label>
                <select id="method" name="method">
                    <option value="GET">GET</option>
                    <option value="POST" selected>POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>

                <label for="encoding">Encoding</label>
                <select id="encoding" name="encoding">
                    <option value="application/x-www-form-urlencoded">Form URL-Encoded</option>
                    <option value="application/json">Application/JSON</option>
                </select>

                <div style="border-top: 1px solid #eeeeee; margin: 10px 0 15px;"></div>
                <h3>Payload Data</h3>

                <label for="message_title">Message Title</label>
                <input type="text" id="message_title" name="title" placeholder="Hello World">

                <label for="message_body">Message Body</label>
                <textarea id="message_body" name="body" rows="4" placeholder="Type your content here..."></textarea>

                <button type="submit" class="hw2-tab">Send Request</button>
            </form>
        </div>

    </div>

    <script>
        // Update UI to show JS is active
        const jsStatus = document.getElementById('js-status');
        jsStatus.textContent = "ON";
        jsStatus.style.color = "#8ab4f8"; // Light Blue

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('echoForm');
            const endpointSelect = document.getElementById('endpoint');
            const methodSelect = document.getElementById('method');
            const encodingSelect = document.getElementById('encoding');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const endpoint = endpointSelect.value;
                const method = methodSelect.value;
                const encoding = encodingSelect.value;

                const formData = new FormData(form);
                const dataObj = Object.fromEntries(formData.entries());

                // Remove config fields from payload
                delete dataObj.endpoint;
                delete dataObj.method;
                delete dataObj.encoding;

                let body = null;
                let url = endpoint;
                const options = {
                    method: method,
                    headers: { 'Accept': 'text/html' }
                };

                if (method === 'GET' || method === 'DELETE') {
                    const params = new URLSearchParams(dataObj).toString();
                    if (params) url += `?${params}`;
                } else {
                    if (encoding === 'application/json') {
                        options.headers['Content-Type'] = 'application/json';
                        body = JSON.stringify(dataObj);
                    } else {
                        options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
                        body = new URLSearchParams(dataObj).toString();
                    }
                    options.body = body;
                }

                try {
                    const res = await fetch(url, options);
                    if (!res.ok) throw new Error(`Status: ${res.status}`);
                    const html = await res.text();
                    document.open();
                    document.write(html);
                    document.close();
                    window.history.pushState({}, '', url);
                } catch (err) {
                    alert("Request Failed: " + err.message);
                }
            });
        });
    </script>
</body>

</html>